<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <meta name=author content="">
    <title>Registration</title>
    <link rel='stylesheet' href="{{url_for('static', filename = 'style.css')}}">
</head>
<body>
<h1>Account</h1>
<form id="home" method="POST" action="{{url_for('home')}}">
        <button id="homebutton" type="submit" name="submit" value="home"> Go to home page </button> 
</form>
<table id="user">
  <tr>
    <th>Username</th>
    <th>Name</th>
    <th>Graduation Year</th>
    <th>Dorm location</th>
    <th>Email</th>
  </tr>
  <tr>
    <td>{{person.username}}</td>
    <td>{{person.name}}</td>
    <td>{{person.gradYear}}</td>
    <td>{{person.dorm}}</td>
    <td>{{person.email}}</td>
  </tr>
</table>

<table id="myPosts">
  <tr>
    <th>Description</th>
    <th>Price</th>
    <th>Category</th>
    <th>Photo</th>
  </tr>
  {% for post in posts %}
  <tr class="post" data-iid="{{post.iid}}">
    <td class="description">{{post.description}}</td>
    <td class="price">{{post.price}}</td>
    <td class="category">{{post.category}}</td>
    <td class="photo"><img src="{{url_for('blob',iid=post.iid)}}"></td>
    {% if isUser %}
    <td><button id="update" name="update" type="submit">Update post</button></td>
    <td>
      <form method="post" action="{{url_for('updatePost')}}">
        </form>
    </td>
    <td><button type="submit" id="delete">Delete post</button></td>
    <td>
      <form method="post" name="delete" action="{{url_for('deletePost')}}">
        <input type="hidden" name="delete">
        </form>
    </td>
    {% endif %}
    {% if not isUser %}
    td>
      <form method="post" name="message" action="{{url_for('messageUser')}}">
        <input type="hidden" name="message">
        </form>
    </td>
    {% endif %}
  </tr>
  {% endfor %}
</table>


<div id="updateDialog" title="Update Details For Item">
  <form id="updateForm" method='POST'>
        <h2 id="itemTitle"> Update Item </h2>
        <input type="hidden" name="iid" id="iid" value="">
        <p><label>Description <br><textarea id="description" rows="4" cols="50" maxlength="100" name="description"></textarea></label></p>
        <p><label>Price $ <br><input id="price" type="text" name="price"></label></p>
        <p><label>Category</label> <br>
             <label for="food">Food</label>
            <input type="radio" name="category" value="food"><br>
            
            <label for="clothing">Clothing</label>
            <input type="radio" name="category" value="clothing"><br>
            
            <label for="shoes">Shoes</label>
            <input type="radio" name="category" value="shoes"><br>
            
            <label for="services">Services</label>
            <input type="radio" name="category" value="services"><br>
            
            <label for="utility">Utility</label>
            <input type="radio" name="category" value="utility"><br>
            
            <label for="makeup">Makeup</label>
            <input type="radio" name="category" value="makeup"><br>
            
            <label for="textbooks">Textbooks</label>
            <input type="radio" name="category" value="textbooks"><br>
            
            <label for="bath-body">Bath-Body</label>
            <input type="radio" name="category" value="bath-body"><br>
            
            <label for="event">Event</label>
            <input type="radio" name="category" value="event"><br>
            
            <label for="other">Other</label>
            <input type="radio" name="category" value="other">
            <input type="text" name="other" value="" id="otherDesc"><br></p>
        <p><button type="submit" id="updateButton">Update</button></p>
    </form>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />

<script type="text/javascript">
  /*global $*/


$('#update').click(function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('retrievePost')}}",{'iid':postID}, fillDialogForm);
    $("#updateDialog").dialog("open");
})

$('#delete').click(function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('deletePost')}}",{'iid':postID}, deletePostRow);
})

$('#updateButton').click(function(){
  var iid = $('#updateDialog').data('iid');
  console.log(iid);
  var description = $('#description').val();
  var price = $('#price').val();
  var category = $("input[name=category]:checked").val();
  var otherDesc = $('#otherDesc').val();
  $.post("{{url_for('updatePost')}}",
            {'description':description, 'price': price,'category':category,
            'otherDesc':otherDesc,'iid':iid}, 
            updatePostInfo);
});

function deletePostRow(obj) {
  $("[data-iid='" + obj + "']").closest("tr").remove();
}

function updatePostInfo(obj) {
  var iid = obj['iid'];
  var post = $("[data-iid='" + iid + "']");
  if (obj['description']) {
    post.find('.description').text(obj['description']);
  }
  console.log(post.find('.description').text());
  if (obj['price']){
    post.find('.price').text(obj['price']);
  }
  if (obj['category']){
    post.find('.category').text(obj['category']);
  }
  if (obj['other']){
    post.find('.otherDesc').text(obj['other']);
  }
}

function fillDialogForm(obj){
  $('#updateDialog').data('iid',obj['iid']);
  $('#updateDialog #iid').val(obj['iid']);
  $('#updateDialog #itemTitle').text('Update item ' + obj['iid']);
  $('#updateDialog #description').val(obj['description']);
  $('#updateDialog #price').val(obj['price']);
  $("#" + obj['category']).prop("checked", true);
}

$(document).ready(function () {
    $(function () {
        $("#updateDialog").dialog({

            autoOpen: false,
            modal: true,
            show: {
                effect: "blind",
                duration: 1000
            },
            hide: {
                effect: "explode",
                duration: 1000
            }
        });
    });
});

</script>
</body>
</html>
