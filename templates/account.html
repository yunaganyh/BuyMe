<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <meta name=author content="">
    <title>Registration</title>
    <link rel='stylesheet' href="{{url_for('static', filename = 'style.css')}}">
</head>
<body>
<h1>Account</h1>
<form id="home" method="POST" action="{{url_for('home')}}">
        <button id="homebutton" type="submit" name="submit" value="home"> Go to home page </button> 
</form>
<h2>User Information</h2>
<table id="user">
  <tr>
    <th>Username</th>
    <th>Name</th>
    <th>Graduation Year</th>
    <th>Dorm location</th>
    <th>Email</th>
  </tr>
  <tr>
    <td>{{person.username}}</td>
    <td>{{person.name}}</td>
    <td>{{person.gradYear}}</td>
    <td>{{person.dorm}}</td>
    <td>{{person.email}}</td>
  </tr>
</table>

<h2>Available Posts</h2>
<table id="myAvailablePosts">
  <tr>
    <th>Description</th>
    <th>Price</th>
    <th>Category</th>
    <th>Other</th>
    <th>Photo</th>
  </tr>
  {% for post in availablePosts %}
  <tr class="post" data-iid="{{post.iid}}">
    <td class="description">{{post.description}}</td>
    <td class="price">{{post.price}}</td>
    <td class="category">{{post.category}}</td>
    <td class="other">{{post.other}}</td>
    <td class="photo">{{post.photo}}</td>
    {% if isUser %}
    <td><button class="update" name="update" type="submit">Update post</button></td>
    <td>
      <form method="post" action="{{url_for('updatePost')}}">
        </form>
    </td>
    <td><button class="delete" name="delete" type="submit">Delete post</button></td>
    <td>
      <form method="post" action="{{url_for('deletePost')}}">
        </form>
    </td>
    <td><button class="markSold" name="markSold" type="submit">Mark as Sold</button></td>
    <td>
      <form method="post" action="{{url_for('markPostSold')}}">
        </form>
    </td>
    {% endif %}
  </tr>
  {% endfor %}
</table>

<h2>Sold Posts</h2>
<table id="mySoldPosts">
  <tr>
    <th>Description</th>
    <th>Price</th>
    <th>Category</th>
    <th>Other</th>
    <th>Photo</th>
  </tr>
  {% for post in soldPosts %}
  <tr class="post" data-iid="{{post.iid}}">
    <td class="description">{{post.description}}</td>
    <td class="price">{{post.price}}</td>
    <td class="category">{{post.category}}</td>
    <td class="other">{{post.other}}</td>
    <td class="photo">{{post.photo}}</td>
  </tr>
  {% endfor %}
</table>


{% if isUser %}
<h2>My conversations</h2>

<h3>Items I'm interested in</h3>
<table id="itemsToBuyMessages">
  <tr>
    <th>Conversation with</th>
    <th>Item</th>
    <th>Message</th>
  </tr>
  {% for message in itemsToBuyMessages %}
  <tr>
    <td class="sender"><a href="{{url_for('account',usernameInput=message.username)}}">{{message.username}}</td>
    <td class="item">{{message.description}}</td>
    <td><button class="openConvo" name="openConvo" type="submit">Open conversation</button></td>
    <td>
      <form method="post" action="{{url_for('openConversation')}}">
        </form>
    </td>
  </tr>
  {% endfor %}
</table>

<h3>Items I'm selling</h3>
<table id="itemsToSellMessages">
  <tr>
    <th>Conversation with</th>
    <th>Item</th>
    <th>Message</th>
  </tr>
  {% for message in itemsToSellMessages %}
  <tr>
    <td class="sender"><a href="{{url_for('account',usernameInput=message.username)}}">{{message.username}}</td>
    <td class="item">{{message.description}}</td>
    <td><button class="openConvo" name="openConvo" type="submit">Open conversation</button></td>
    <td>
      <form method="post" action="{{url_for('openConversation')}}">
        </form>
    </td>
  </tr>
  {% endfor %}
</table>
{% endif %}


<div id="updateDialog" title="Update Details For Item">
  <form id="updateForm" method='POST'>
        <h2 id="itemTitle"> Update Item </h2>
        <input type="hidden" name="iid" id="iid" value="">
        <p><label><b><em>Description </em></b><br><textarea id="description" rows="4" cols="50" maxlength="100" name="description"></textarea></label></p>
        <p><label><b><em>Price $ </em></b><br><input id="price" type="text" name="price"></label></p>
        <p><label><b><em>Category</em></b></label> <br>
            <input type="radio" name="category" value="food" id="food"> food <br>
            <input type="radio" name="category" value="clothing" id="clothing"> clothing <br>
            <input type="radio" name="category" value="shoes" id="shoes"> shoes <br>
            <input type="radio" name="category" value="services" id="services"> services <br>
            <input type="radio" name="category" value="utility" id="utility"> utility <br>
            <input type="radio" name="category" value="makeup" id="makeup"> makeup <br>
            <input type="radio" name="category" value="bath-body" id="bath-body"> bath-body <br>
            <input type="radio" name="category" value="event" id="event"> event <br>
            <input type="radio" name="category" value="other" id="other">other 
            <input type="text" name="other" value="" id="otherDesc"><br></p>
        <p><button type="submit" id="updateButton">Update</button></p>
    </form>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />

<script type="text/javascript">
  /*global $*/


$('#myAvailablePosts').on('click','.update',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('retrievePost')}}",{'iid':postID}, fillDialogForm);
    $("#updateDialog").dialog("open");
})

$('#myAvailablePosts').on('click','.delete',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('deletePost')}}",{'iid':postID}, deletePostRow);
})

$('#myAvailablePosts').on('click','.markSold',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('markPostSold')}}",{'iid':postID}, markPostAsSold);
})

$('#updateButton').click(function(){
  var iid = $('#updateDialog').data('iid');
  var description = $('#description').val();
  var price = $('#price').val();
  var category = $("input[name=category]:checked").val();
  var otherDesc = $('#otherDesc').val();
  $.post("{{url_for('updatePost')}}",
            {'description':description, 'price': price,'category':category,
            'otherDesc':otherDesc,'iid':iid}, 
            updatePostInfo);
});

function markPostAsSold(obj) {
  var row =  $("[data-iid='" + obj + "']").closest("tr");
  $('#mySoldPosts').append(row);
  
}

function deletePostRow(obj) {
  $("[data-iid='" + obj + "']").closest("tr").remove();
}

function updatePostInfo(obj) {
  var iid = obj['iid'];
  var post = $("[data-iid='" + iid + "']");
  if (obj['description']) {
    post.find('.description').text(obj['description']);
  }
  if (obj['price']){
    post.find('.price').text(obj['price']);
  }
  if (obj['category']){
    post.find('.category').text(obj['category']);
  }
  if (obj['other']){
    post.find('.otherDesc').text(obj['other']);
  }
}

function fillDialogForm(obj){
  $('#updateDialog').data('iid',obj['iid']);
  $('#updateDialog #iid').val(obj['iid']);
  $('#updateDialog #itemTitle').text('Update item ' + obj['iid']);
  $('#updateDialog #description').val(obj['description']);
  $('#updateDialog #price').val(obj['price']);
  $("#" + obj['category']).prop("checked", true);
}

$(document).ready(function () {
    $(function () {
        $("#updateDialog").dialog({

            autoOpen: false,
            modal: true,
            show: {
                effect: "blind",
                duration: 1000
            },
            hide: {
                effect: "explode",
                duration: 1000
            }
        });
    });
});

</script>
</body>
</html>
