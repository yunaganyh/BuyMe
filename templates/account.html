<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <meta name=author content="">
    <title>Registration</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel='stylesheet' href="{{url_for('static', filename = 'style.css')}}">
</head>
<body>
<h1>Account</h1>
<form id="home" method="POST" action="{{url_for('home')}}">
        <button id="homebutton" type="submit" name="submit" value="home"> Go to home page </button> 
</form>
<h2>User Information</h2>

<table class="table table-hover" id="user">
  <thead class="thead-light">

  <tr>
    <th>Username</th>
    <th>Name</th>
    <th>Graduation Year</th>
    <th>Dorm location</th>
    <th>Email</th>
  </tr></thead>
  <tr>
    <td>{{person.username}}</td>
    <td>{{person.name}}</td>
    <td>{{person.gradYear}}</td>
    <td>{{person.dorm}}</td>
    <td>{{person.email}}</td>
  </tr>
</table>

<h2>Available Posts</h2>
<table class="table table-hover" id="myAvailablePosts">
  <thead class="thead-light">
  <tr>
    <th>Description</th>
    <th>Price</th>
    <th>Category</th>
    <th>Other</th>
    <th>Photo</th>
  </tr></thead>
  
  {% for post in availablePosts %}
  <tr class="post" data-iid="{{post.iid}}">
    <td class="description">{{post.description}}</td>
    <td class="price">{{post.price}}</td>
    <td class="category">{{post.category}}</td>
    <td class="other">{{post.other}}</td>
    <td class="photo"><img src="{{url_for('blob',iid=post.iid)}}"></td>
    {% if isUser %}
    <td><button class="update" name="update" type="submit">Update post</button></td>
    <td>
      <form method="post" action="{{url_for('updatePost')}}">
        </form>
    </td>
    <td><button class="delete" name="delete" type="submit">Delete post</button></td>
    <td>
      <form method="post" action="{{url_for('deletePost')}}">
        </form>
    </td>
    <td><button class="markSold" name="markSold" type="submit">Mark as Sold</button></td>
    <td>
      <form method="post" action="{{url_for('markPostSold')}}">
        </form>
    </td>
    {% endif %}
  </tr>
  {% endfor %}
</table>

<h2>Sold Posts</h2>
<table class="table table-hover" id="mySoldPosts">
  <thead class="thead-light">
  <tr>
    <th>Description</th>
    <th>Price</th>
    <th>Category</th>
    <th>Other</th>
    <th>Photo</th>
  </tr></thead>
  {% for post in soldPosts %}
  <tr class="post" data-iid="{{post.iid}}">
    <td class="description">{{post.description}}</td>
    <td class="price">{{post.price}}</td>
    <td class="category">{{post.category}}</td>
    <td class="other">{{post.other}}</td>
    <td class="photo"><img src="{{url_for('blob',iid=post.iid)}}"></td>
  </tr>
  {% endfor %}
</table>


{% if isUser %}
<h2>My conversations</h2>

<div id="messages">
<h3>Items I'm interested in</h3>
<table class="table table-hover" id="itemsToBuyMessages">
  <thead class="thead-light">
  <tr>
    <th>Conversation with</th>
    <th>Item</th>
    <th>Message</th>
  </tr></thead>
  {% for message in itemsToBuyMessages %}
  <tr data-uid={{message.uid}} data-iid={{message.iid}}>
    <td class="sender"><a href="{{url_for('account',usernameInput=message.username)}}">{{message.username}}</td>
    <td class="item">{{message.description}}</td>
    <td><button class="openConvo" name="senderIsUser" type="submit">Open conversation</button></td>
    <td>
      <form method="post" action="">
        </form>
    </td>
  </tr>
  {% endfor %}
</table>

<h3>Items I'm selling</h3>
<table class="table table-hover" id="itemsToSellMessages">
  <thead class="thead-light">
  <tr>
    <th>Conversation with</th>
    <th>Item</th>
    <th>Message</th>
  </tr></thead>
  {% for message in itemsToSellMessages %}
  <tr data-uid={{message.uid}} data-iid={{message.iid}}>
    <td class="sender"><a href="{{url_for('account',usernameInput=message.username)}}">{{message.username}}</td>
    <td class="item">{{message.description}}</td>
    <td><button class="openConvo" name="senderNotUser" type="submit">Open conversation</button></td>
    <td>
      <form method="post" action="">
        </form>
    </td>
  </tr>
  {% endfor %}
</table>
{% endif %}
</div>

<div id="updateDialog" title="Update Details For Item">
  <form id="updateForm" method='POST'>
        <h2 id="itemTitle"> Update Item </h2>
        <input type="hidden" name="iid" id="iid" value="">
        <p><label>Description <br><textarea id="description" rows="4" cols="50" maxlength="100" name="description"></textarea></label></p>
        <p><label>Price $ <br><input id="price" type="text" name="price"></label></p>
        <p><label>Category</label> <br>
             <label for="food">Food</label>
            <input type="radio" name="category" value="food"><br>
            
            <label for="clothing">Clothing</label>
            <input type="radio" name="category" id="clothing" value="clothing"><br>
            
            <label for="shoes">Shoes</label>
            <input type="radio" name="category" id="shoes" value="shoes"><br>
            
            <label for="services">Services</label>
            <input type="radio" name="category" id="services" value="services"><br>
            
            <label for="utility">Utility</label>
            <input type="radio" name="category" id="utility" value="utility"><br>
            
            <label for="makeup">Makeup</label>
            <input type="radio" name="category" id="makeup" value="makeup"><br>
            
            <label for="textbooks">Textbooks</label>
            <input type="radio" name="category" id="textbooks" value="textbooks"><br>
            
            <label for="bath-body">Bath-Body</label>
            <input type="radio" name="category" id="bath-body" value="bath-body"><br>
            
            <label for="event">Event</label>
            <input type="radio" name="category" id="event" value="event"><br>
            
            <label for="other">Other</label>
            <input type="radio" name="category" id="other" value="other">
            <input type="text" name="other" value="" id="otherDesc"><br></p></label>
        <p><button type="submit" id="updateButton">Update</button></p>
    </form>
</div>

<div id="convoDialog">
  <input type="hidden" id="messageIID" value="">
  <input type="hidden" id="messageSender" value="">
  <table id="conversation"></table>
  <textarea id="reply" rows="4" cols="50"></textarea>
  <p><button type=submit id="replyButton">Submit Reply</button></p>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />

<script type="text/javascript">
  /*global $*/

function sanitize(string) {
  const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      "/": '&#x2F;',
  };
  const reg = /[&<>"'/]/ig;
  return string.replace(reg, (match)=>(map[match]));
}

$('#replyButton').click(function(){
  var reply = $('#reply').val();
  var sender = $('#convoDialog #messageSender').val();
  var iid = $('#convoDialog #messageIID').val();
  $.post("{{url_for('messageUser')}}",
        {'uid':sender,'description':reply,'iid':iid}, closeConvo)
})

$('#messages').on('click','.openConvo', function() {
  var iid = $(this).closest('tr').data('iid');
  var uid = $(this).closest('tr').data('uid');
  var buttonClicked = $(this).attr('name');
  $.post("{{url_for('retrieveMessages')}}",
        {'iid':iid,'uid':uid, 'sender':buttonClicked}, 
        fillConvoDialog);
  $('#convoDialog').dialog('open');
})

$('#myAvailablePosts').on('click','.update',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('retrievePost')}}",{'iid':postID}, fillDialogForm);
    $("#updateDialog").dialog("open");
})

$('#myAvailablePosts').on('click','.delete',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('deletePost')}}",{'iid':postID}, deletePostRow);
})

$('#myAvailablePosts').on('click','.markSold',function(){
    var postID = $(this).closest('tr').data('iid');
    $.post("{{url_for('markPostSold')}}",{'iid':postID}, markPostAsSold);
})

$('#updateButton').click(function(){
  var iid = $('#updateDialog').data('iid');
  var description = sanitize($('#description').val());
  var price = $('#price').val();
  var category = $("input[name=category]:checked").val();
  var otherDesc = sanitize($('#otherDesc').val());
  $.post("{{url_for('updatePost')}}",
            {'description':description, 'price': price,'category':category,
            'otherDesc':otherDesc,'iid':iid}, 
            updatePostInfo);
});

function fillConvoDialog(obj) {
  $('#conversation').empty();
  $('#reply').val('');
  if (obj['sender']=="senderNotUser"){
    $('#convoDialog #messageSender').val(obj['messages'][0]['sender']);
  } else {
    $('#convoDialog #messageSender').val(obj['messages'][0]['receiver']);
  }
  $('#convoDialog #messageIID').val(obj['messages'][0]['iid']);
  $('#conversation').append(
    '<tr><th>User</th><th>Message</th><th>Time sent</th></tr>')
  for (var message in obj['messages']){
    var m = obj['messages'][message];
    $('#convoDialog #conversation').append('<tr><td>' + m['username'] + '</td><td>'
    + m['message']+ '</td><td>' + m['messageSent'].split(' ').slice(0,-1).join(' ') 
    + '</td></tr>');
  }
}

function markPostAsSold(obj) {
  var row =  $("[data-iid='" + obj + "']").closest("tr");
  $('#mySoldPosts').append(row);
}

function deletePostRow(obj) {
  $("[data-iid='" + obj + "']").closest("tr").remove();
}

function updatePostInfo(obj) {
  console.log(obj);
  var iid = obj['iid'];
  var post = $("[data-iid='" + iid + "']");
  post.closest('tr').find('.description').val(obj['description']);
  post.closest('tr').find('.price').val(obj['price']);
  post.closest('tr').find('.category').val(obj['category']);
  post.closest('tr').find('.other').val(obj['other']);
}

function fillDialogForm(obj){
  $('#updateDialog').data('iid',obj['iid']);
  $('#updateDialog #iid').val(obj['iid']);
  $('#updateDialog #itemTitle').text('Update item ' + obj['iid']);
  $('#updateDialog #description').val(obj['description']);
  $('#updateDialog #price').val(obj['price']);
  $('#updateDialog #otherDesc').val(obj['other']);
  if (obj['category'] == '') {
    $("#updateDialog #other").prop("checked", true);
  } else {
    $("#updateDialog #" + obj['category']).prop("checked", true);
  }
}

function closeConvo(obj){
  if (obj) {
    $('#convoDialog').dialog('close');
    alert('Message successfully sent.')
  } else{
    alert('Message not sent.')
  }
}

$(document).ready(function () {
    $(function () {
        $("#updateDialog").dialog({

            autoOpen: false,
            modal: true,
            show: {
                effect: "blind",
                duration: 500
            },
            hide: {
                effect: "drop",
                duration: 500
            }
        });
    });
});

$(document).ready(function () {
    $(function () {
        $("#convoDialog").dialog({

            autoOpen: false,
            modal: true,
            show: {
                effect: "blind",
                duration: 500
            },
            hide: {
                effect: "drop",
                duration: 500
            }
        });
    });
});

</script>
</body>
</html>
